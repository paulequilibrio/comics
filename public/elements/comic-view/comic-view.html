<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">

<dom-module id="comic-view">
    <template>
        <style>
          :host {
            display: block;
            height: 100%;
            width: 100%;
          }

          iron-image {
            background-color: lightgray;
            --iron-image-width: 100%;
          }
        </style>

        <template is="dom-if" if="{{isHome()}}">
            <h2>How to use</h2>
            <p>Just choose one source from the left menu to see the lastest posted comic strip.</p>
        </template>

        <template is="dom-if" if="{{!isHome()}}">
            <iron-ajax
                auto
                url="{{host}}api/v1{{comicSource}}"
                handle-as="json"
                last-response="{{comic}}"
                debounce-duration="500">
            </iron-ajax>

            <h1>
                <span>Published by <a href="{{comic.source}}">{{comic.author}}</a></span>
            </h1>
            <p>on {{date}}</p>
            <h2>
                <span>{{comic.title}}</span>{{setHeight(comic.comic)}}
            </h2>
            <iron-image style="width:{{width}}px; height:{{height}}px;" sizing="contain" preload fade src="{{comic.comic}}"></iron-image>
        </template>
    </template>

    <script>
      (function() {
      'use strict';
          Polymer({
              is: 'comic-view',
              properties: {
                  host: {
                      type: String,
                      notify: true
                  },
                  comicSource: {
                    type: String,
                    value: window.location.pathname
                  },
                  comic: {
                      type: Object,
                      notify: true
                  },
                  date: {
                      type: String,
                      notify: true,
                      computed: 'formatDate(comic.published)'
                  },
                  width: {
                      type: Number,
                      notify: true,
                  },
                  height: {
                      type: Number,
                      notify: true,
                  }
              },

              formatDate(published){
                  return moment(published).format('LLLL');
              },

              isHome(){
                  if (window.location.pathname === '/') { return true; }
                  else { return false; }
              },

              setHeight(url){
                  var self = this;
                  var img = new Image();
                  img.onload = function(){
                      self.width = document.querySelector('#container').clientWidth-17; // scrollbar width=17px
                      self.height = img.height*(self.width/img.width);
                      console.log('width', self.width);
                      console.log('height', self.height);
                  }
                  img.src = url;
              }
          });
      })();
    </script>
</dom-module>
